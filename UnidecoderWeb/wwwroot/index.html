<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Uni-decoder</title>
    <script type="text/javascript">
        //if (false && 'serviceWorker' in navigator) {
        //    console.log("registering service worker after load");
        //    window.addEventListener('load', function () {
        //        navigator.serviceWorker.register('/serviceworker.js').then(function (registration) {
        //            // Registration was successful
        //            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        //        }, function (err) {
        //            // registration failed :(
        //            console.log('ServiceWorker registration failed: ', err);
        //        });
        //    });
        //} else {
        //    console.log("no service worker support");
        //}
    </script>
    <script type="text/javascript" src="js/process.js"></script>
    <script type="text/javascript" src="js/handlebars.min.js"></script>
    <script>
        var resultTemplate;
        function setResultTemplate() {
            if (!resultTemplate) {
                var templateElement = document.getElementById('result-template');
                var templateSource = templateElement.innerHTML;
                resultTemplate = Handlebars.compile(templateSource);
            }
        }

        async function processDecoder(source, targetId, linkId) {
            setResultTemplate();
            if (typeof (source) === "string") {
                source = document.getElementById(source);
            }

            // property(-name) "characters" of "data" matches {{#each characters}} in template
            var data = { characters: await decoder.expandToChars(source.value) };

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;

            var link = document.getElementById(linkId);
            link.href = document.location.href.split('#')[0];
            link.href += "#s=" + encodeURI(source.value);
        }

        async function processSearch(source, targetId, linkId) {
            setResultTemplate();
            if (typeof (source) === "string") {
                source = document.getElementById(source);
            }

            // property(-name) "characters" of "data" matches {{#each characters}} in template
            var data = { characters: await decoder.findChars(source.value) };

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;

            var link = document.getElementById(linkId);
            link.href = document.location.href.split('#')[0];
            link.href += "#q=" + encodeURI(source.value);
        }

        async function processBlockSearch(source, targetId, linkId) {
            setResultTemplate();
            if (typeof (source) === "string") {
                source = document.getElementById(source);
            }

            var blockId = 1 * source.value; // make sure it's a number
            console.log("finding block " + blockId);

            var data = { characters: await decoder.findCharsByBlock(blockId) };
            console.log("got block " + blockId);

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;

            if (linkId) {
                var link = document.getElementById(linkId);
                link.href = document.location.href.split('#')[0];
                link.href += "#b=" + encodeURI(source.value);
            }
        }

        async function setBlockSelect() {
            var templateElement = document.getElementById('blockselect-template');
            var templateSource = templateElement.innerHTML;
            var blockTemplate = Handlebars.compile(templateSource);

            var blocklist = await decoder.getBlockList();
            var data = { blocks: blocklist };
            var content = blockTemplate(data);

            var targetElement = document.getElementById("blockSelect");
            targetElement.innerHTML = content;
        }

        function opentab(tabElement, tabContentName) {
            if (typeof (tabElement) === "string") {
                // supplied as id-string, convert to element
                tabElement = document.getElementById(tabElement);
            }

            for (var elt of document.getElementsByClassName("tab")) {
                elt.classList.remove("opened");
            }

            tabElement.classList.add("opened");

            for (var elt of document.getElementsByClassName("tabcontent")) {
                elt.classList.remove("visible");
            }

            var tab = document.getElementById(tabContentName);
            tab.classList.add("visible");
        }

        function handleHash() {
            // window.location.hash is including '#'
            if (window.location.hash) {
                console.log("HASH: " + window.location.hash);
                var srch = window.location.hash.substr(1); // remove initial '#'
                srch = srch.split('=');  // variable = value
                switch (srch[0]) {
                    case 's':
                        console.log("show chars of " + srch[1]);
                        opentab('tab2', 'tabcontent2');
                        document.getElementById("sampleString").value = decodeURI(srch[1]);
                        processDecoder('sampleString', 'result2', 'link2');
                        break;
                    case 'q':
                        console.log("search chars by " + srch[1]);
                        opentab('tab3', 'tabcontent3');
                        document.getElementById("searchString").value = decodeURI(srch[1]);
                        processSearch('searchString', 'result3', 'link3');
                        break;
                    case 'b':
                        console.log("show block " + srch[1]);
                        opentab('tab4', 'tabcontent4');
                        // value is internal ID of block
                        document.getElementById("blockSelect").value = decodeURI(srch[1]);
                        processBlockSearch('blockSelect', 'result4', 'link4')
                        break;
                }
            }

        }
        </script>
    <link type="text/css" rel="stylesheet" href="css/site.min.css" />
</head>
<body>
    <h1>Unicode decoder</h1>

    <div id="tablist">
        <div class="tab opened" id="tab1" onclick="opentab(this, 'tabcontent1')">Intro</div>
        <div class="tab" id="tab2" onclick="opentab(this, 'tabcontent2')">Show characters in text</div>
        <div class="tab" id="tab3" onclick="opentab(this, 'tabcontent3')">Find characters by name</div>
        <div class="tab" id="tab4" onclick="opentab(this, 'tabcontent4')">Find characters by block</div>
    </div>

    <!-- tab: intro -->
    <div id="tabcontent1" class="tabcontent visible">
        <h2>Introduction</h2>
        <p>Every character (letter, digit, punctuation, emoji,...) of any language has its own codepoint and name.</p>
        <p>Use the other tabs to find out about them.</p>

        <p>Characters are shown like this:</p>
        <div class="result">
            <div class="character">
                <p>a</p>
                <p><strong>Latin Small Letter A</strong></p>
                <p><em>Lowercase Letter</em></p>
                <p>0061 - 97</p>
            </div>
        </div>

        <p>Meaning:
        <ul>
            <li>(big, in grey) The character (if it is available in the current font - not all are)</li>
            <li>(bold) The name of the character (search for this in tab 3)</li>
            <li>The block name (see tab 4)</li>
            <li>(cursive) The category of the character</li>
            <li>The codepoint of the character: hexadecimal and decimal</li>
        </ul>
        </p>
    </div>

    <!-- tab: show characters -->
    <div id="tabcontent2" class="tabcontent">
        <h2>Character details</h2>
        <p>Type in (or copy in) some text. Information about all characters in it will be shown.</p>
        <p>For example: "<a href="index.html#s=cr%C3%A8me%20br%C3%BBl%C3%A9e">Cre&#x0300;me brûlée</a>"</p>
        <input id="sampleString" type="text" placeholder="Input text to inspect" autofocus required
               onkeyup="processDecoder(this, 'result2', 'link2')" style="width:100%" />
        <!--
      onkeypress reageert niet op "wissen" en geeft oude waarde
      onkeyup reageert ook op cursor keys maar geeft juiste waarde
    -->
        <p><a href="#s=" id="link2">Direct link</a></p>
        <div id="result2" class="result">&hellip;</div>
    </div>

    <!-- tab: search by name -->
    <div id="tabcontent3" class="tabcontent">
        <h2>Search by name</h2>
        <p>Type in a partial name of a character or type in its code to find out about it. 
        When you type in a numerical code (decimal or hexadecimal), some characters around it will also be shown.</p>
        <p>When there are too many matches, the list is truncated. Use a more specific search (you can use multiple words) to get a more specific result.</p>
        <p>Examples: <a href="index.html#q=phone">phone</a> or <a href="index.html#q=egyptian%20hieroglyph">egyptian hieroglyph</a></p>
        <input id="searchString" type="text" placeholder="Input name to find" autofocus required
               oninput="processSearch(this, 'result3', 'link3')" style="width:100%" />
        <p><a href="#q=" id="link3">Direct link</a></p>
        <div id="result3" class="result">&hellip;</div>
    </div>

    <!-- tab: select block -->
    <div id="tabcontent4" class="tabcontent">
        <h2>Search by block</h2>
        <p>Select a block to see its characters.</p>
        <select id="blockSelect" onchange="processBlockSearch(this, 'result4', 'link4')"></select>
        <p><a href="#b=0" id="link4">Direct link</a></p>
        <div id="result4" class="result">&hellip;</div>
    </div>


    <script id="result-template" type="text/x-handlebars-template">
        {{#each characters}}
        <div class="character">
            <p>&#x{{this.hex}};</p>
            <p><strong>{{this.name}}</strong></p>
            <p>{{this.block}}</p>
            <p><em>{{this.category}}</em></p>
            <p>{{this.hex}} - {{this.codepoint}}</p>
        </div>
        {{/each}}
    </script>

    <script id="blockselect-template" type="text/x-handlebars-template">
        {{#each blocks}}
        <option value="{{this.index}}">{{this.name}}</option>
        {{/each}}
    </script>

    <script type="text/javascript">
        (async function () {
            // also pre-fetches the charlist
            await setBlockSelect();
            await processBlockSearch('blockSelect', 'result4');

            window.addEventListener("hashchange", handleHash);
            handleHash();
        })();
    </script>
</body>
</html>