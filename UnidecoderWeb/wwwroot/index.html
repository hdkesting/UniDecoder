<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Uni-decoder</title>
    <script type="text/javascript">
        //if (false && 'serviceWorker' in navigator) {
        //    console.log("registering service worker after load");
        //    window.addEventListener('load', function () {
        //        navigator.serviceWorker.register('/serviceworker.js').then(function (registration) {
        //            // Registration was successful
        //            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        //        }, function (err) {
        //            // registration failed :(
        //            console.log('ServiceWorker registration failed: ', err);
        //        });
        //    });
        //} else {
        //    console.log("no service worker support");
        //}
    </script>
    <script type="text/javascript" src="js/process.js"></script>
    <script type="text/javascript" src="js/handlebars.min.js"></script>
    <script>
        var resultTemplate;
        function setResultTemplate() {
            if (!resultTemplate) {
                var templateElement = document.getElementById('result-template');
                var templateSource = templateElement.innerHTML;
                resultTemplate = Handlebars.compile(templateSource);
            }
        }

        async function processDecoder(source, targetId) {
            setResultTemplate();

            // property(-name) "characters" of "data" matches {{#each characters}} in template
            var data = { characters: await decoder.expandToChars(source.value) };

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;
        }

        async function processSearch(source, targetId) {
            setResultTemplate();

            // property(-name) "characters" of "data" matches {{#each characters}} in template
            var data = { characters: await decoder.findChars(source.value) };

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;
        }

        async function processBlockSearch(source, targetId) {
            setResultTemplate();

            var blockId = 1 * source.value; // make sure it's a number
            console.log("finding block " + blockId);

            var data = { characters: await decoder.findCharsByBlock(blockId) };
            console.log("got block " + blockId);

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;
        }

        async function setBlockSelect() {
            var templateElement = document.getElementById('blockselect-template');
            var templateSource = templateElement.innerHTML;
            var blockTemplate = Handlebars.compile(templateSource);

            var blocklist = await decoder.getBlockList();
            var data = { blocks: blocklist };
            var content = blockTemplate(data);

            var targetElement = document.getElementById("blockSelect");
            targetElement.innerHTML = content;
        }

        function opentab(tabElement, tabContentName) {
            for (var elt of document.getElementsByClassName("tab")) {
                elt.classList.remove("opened");
            }

            tabElement.classList.add("opened");

            for (var elt of document.getElementsByClassName("tabcontent")) {
                elt.classList.remove("visible");
            }

            var tab = document.getElementById(tabContentName);
            tab.classList.add("visible");
        }

        </script>
    <link type="text/css" rel="stylesheet" href="css/site.min.css" />
</head>
<body>
    <h1>Unicode decoder</h1>

    <div id="tablist">
        <div class="tab opened" onclick="opentab(this, 'tab1')">Intro</div>
        <div class="tab" onclick="opentab(this, 'tab2')">Show characters in text</div>
        <div class="tab" onclick="opentab(this, 'tab3')">Find characters by name</div>
        <div class="tab" onclick="opentab(this, 'tab4')">Find characters by block</div>
    </div>

    <div id="tab1" class="tabcontent visible">
        <h2>Introduction</h2>
        <p>Every character (letter, digit, punctuation, ...) of any language has its own codepoint and name.</p>
        <p>Use the other tabs to find out about them.</p>
    </div>

    <div id="tab2" class="tabcontent">
        <h2>Character details</h2>
        <p>Type in (or copy in) some text. Information about all characters in it will be shown.</p>
        <input id="sampleString" type="text" placeholder="Input text to inspect" autofocus required
               onkeyup="processDecoder(this, 'result2')" style="width:100%" />
        <!--
      onkeypress reageert niet op "wissen" en geeft oude waarde
      onkeyup reageert ook op cursor keys maar geeft juiste waarde
    -->
        <p>&nbsp;</p>
        <div id="result2" class="result">&hellip;</div>
    </div>

    <div id="tab3" class="tabcontent">
        <h2>Search by name</h2>
        <p>Type in a partial name of a character or type in its code to find out about it.</p>
        <input id="searchString" type="text" placeholder="Input name to find" autofocus required
               onkeyup="processSearch(this, 'result3')" style="width:100%" />
        <p>&nbsp;</p>
        <div id="result3" class="result">&hellip;</div>
    </div>

    <div id="tab4" class="tabcontent">
        <h2>Search by block</h2>
        <p>Select a block to see its characters.</p>
        <select id="blockSelect" onchange="processBlockSearch(this, 'result4')"></select>
        <div id="result4" class="result">&hellip;</div>
    </div>


    <script id="result-template" type="text/x-handlebars-template">
        {{#each characters}}
        <div class="character">
            <p>&#x{{this.hex}};</p>
            <p><strong>{{this.name}}</strong></p>
            <p>{{this.block}}</p>
            <p><em>{{this.category}}</em></p>
            <p>{{this.hex}} - {{this.codepoint}}</p>
        </div>
        {{/each}}
    </script>

    <script id="blockselect-template" type="text/x-handlebars-template">
        {{#each blocks}}
        <option value="{{this.index}}">{{this.name}}</option>
        {{/each}}
    </script>

    <script type="text/javascript">
        (async function () {
            // also pre-fetches the charlist
            await setBlockSelect();
            await processBlockSearch(document.getElementById('blockSelect'), 'result4');
        })();
    </script>
</body>
</html>