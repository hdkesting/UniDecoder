<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Uni-decoder</title>
    <script type="text/javascript">
        //if (false && 'serviceWorker' in navigator) {
        //    console.log("registering service worker after load");
        //    window.addEventListener('load', function () {
        //        navigator.serviceWorker.register('/serviceworker.js').then(function (registration) {
        //            // Registration was successful
        //            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        //        }, function (err) {
        //            // registration failed :(
        //            console.log('ServiceWorker registration failed: ', err);
        //        });
        //    });
        //} else {
        //    console.log("no service worker support");
        //}
    </script>
    <script type="text/javascript" src="js/unidecoder.js"></script>
    <script type="text/javascript" src="js/handlebars.min.js"></script>
    <script>
        var resultTemplate;
        function setResultTemplate() {
            if (!resultTemplate) {
                var templateElement = document.getElementById('result-template');
                var templateSource = templateElement.innerHTML;
                resultTemplate = Handlebars.compile(templateSource);
            }
        }

        function setLink(linkid, tag, value) {
            if (linkid) {
                var link = document.getElementById(linkid);
                link.href = document.location.href.split('#')[0];
                link.href += `#${tag}=${encodeURI(value)}`;
                    //"#" + tag + "=" + encodeURI(source.value);
            }
        }

        async function processDecoder(source, targetId, linkId) {
            setResultTemplate();
            if (typeof (source) === "string") {
                source = document.getElementById(source);
            }

            // property(-name) "characters" of "data" matches {{#each characters}} in template
            var data = { characters: await decoder.expandToChars(source.value) };

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;

            setLink(linkId, 's', source.value);
        }

        async function processSearch(source, targetId, linkId) {
            setResultTemplate();
            if (typeof (source) === "string") {
                source = document.getElementById(source);
            }

            // property(-name) "characters" of "data" matches {{#each characters}} in template
            var data = { characters: await decoder.findChars(source.value) };

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;

            setLink(linkId, 'q', source.value);
        }

        async function processBlockSearch(source, targetId, linkId) {
            setResultTemplate();
            if (typeof (source) === "string") {
                source = document.getElementById(source);
            }

            var blockId = 1 * source.value; // make sure it's a number
            console.log("finding block " + blockId);

            var data = { characters: await decoder.findCharsByBlock(blockId) };
            console.log("got block " + blockId);

            var targetElement = document.getElementById(targetId);
            var content = resultTemplate(data);
            targetElement.innerHTML = content;

            setLink(linkId, 'b', source.value);
        }

        async function setBlockSelect() {
            var templateElement = document.getElementById('blockselect-template');
            var templateSource = templateElement.innerHTML;
            var blockTemplate = Handlebars.compile(templateSource);

            var blocklist = await decoder.getBlockList();
            var data = { blocks: blocklist };
            var content = blockTemplate(data);

            var targetElement = document.getElementById("blockSelect");
            targetElement.innerHTML = content;
        }

        async function setCharCount() {
            var count = await decoder.getCharCount();
            var targetElement = document.getElementById("charcount");
            targetElement.innerHTML = count;
        }

        function opentab(tabElement, tabContentName) {
            if (typeof (tabElement) === "string") {
                // supplied as id-string, convert to element
                tabElement = document.getElementById(tabElement);
            }

            var elts = document.getElementsByClassName("tab");
            for (let i = 0; i < elts.length; i++) {
                elts.item(i).classList.remove("opened");
            }

            tabElement.classList.add("opened");

            var elts = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < elts.length; i++) {
                elts.item(i).classList.remove("visible");
            }

            var tab = document.getElementById(tabContentName);
            tab.classList.add("visible");

            var inputs = tab.getElementsByTagName("input");
            if (inputs.length) {
                inputs[0].focus();
            }
        }

        function handleHash() {
            // window.location.hash is including '#'
            if (window.location.hash) {
                console.log("HASH: " + window.location.hash);
                var srch = window.location.hash.substr(1); // remove initial '#'
                srch = srch.split('=');  // variable = value
                switch (srch[0]) {
                    case 's':
                        console.log("show chars of " + srch[1]);
                        opentab('tab2', 'tabcontent2');
                        document.getElementById("sampleString").value = decodeURI(srch[1]);
                        processDecoder('sampleString', 'result2', 'link2');
                        break;
                    case 'q':
                        console.log("search chars by " + srch[1]);
                        opentab('tab3', 'tabcontent3');
                        document.getElementById("searchString").value = decodeURI(srch[1]);
                        processSearch('searchString', 'result3', 'link3');
                        break;
                    case 'b':
                        console.log("show block " + srch[1]);
                        opentab('tab4', 'tabcontent4');
                        // value is internal ID of block
                        document.getElementById("blockSelect").value = decodeURI(srch[1]);
                        processBlockSearch('blockSelect', 'result4', 'link4')
                        break;
                }
            }
        }

        function cp(cp, name) {
            let ch = String.fromCodePoint(cp);
            window.prompt("Use Ctrl+C to copy the character '" + name + "'", ch);
        }
        </script>
    <link type="text/css" rel="stylesheet" href="css/site.min.css" />
</head>
<body>
    <h1>Unicode decoder</h1>

    <div id="tablist">
        <div class="tab opened" id="tab1" onclick="opentab(this, 'tabcontent1')">Intro</div>
        <div class="tab" id="tab2" onclick="opentab(this, 'tabcontent2')">Show characters in text</div>
        <div class="tab" id="tab3" onclick="opentab(this, 'tabcontent3')">Find characters by name</div>
        <div class="tab" id="tab4" onclick="opentab(this, 'tabcontent4')">Find characters by block</div>
    </div>

    <!-- tab: intro -->
    <div id="tabcontent1" class="tabcontent visible">
        <h2>Introduction</h2>
        <p>Every character (letter, digit, punctuation, emoji,...) of any language has its own codepoint and name in the Unicode character set.
        For more info, see the <a href="https://www.unicode.org/faq/">Unicode FAQ</a>.<br/>
        This app knows details about <span id="charcount">a lot</span> of them.
        </p>
        <p>Use the other tabs to find out about them:
        <ul>
            <li><strong>Show characters</strong>: shows the characters in a text that you maybe copied from somewhere.</li>
            <li><strong>Find characters</strong>: tries to find characters by name or codepoint.</li>
            <li><strong>Find by block</strong>: shows all characters that belong to a selected block.</li>
        </ul>
        </p>

        <p>Characters are shown like this:</p>
        <div class="result">
            <div class="character">
                <p class="latin">a</p>
                <p><strong>Latin Small Letter A</strong></p>
                <p>Basic Latin</p>
                <p><em>Lowercase Letter</em></p>
                <p>0061 - 97</p>
            </div>
        </div>

        <p>Meaning:
        <ul>
            <li>(big, in grey) The character (if it is available in the current font &ndash; not all are, then it will be a thin rectangle)</li>
            <li>(bold) The name of the character (search for this in tab 3)</li>
            <li>The block name (see tab 4)</li>
            <li>(cursive) The category of the character</li>
            <li>The codepoint of the character: both hexadecimal and decimal</li>
        </ul>
        </p>
        <p style="margin-top: 50px">
            <a href="https://stackoverflow.com/users/121309/hans-kesting">
                <img src="https://stackoverflow.com/users/flair/121309.png?theme=default" width="208" height="58" alt="profile for Hans Kesting at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Hans Kesting at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
            </a>
        </p>
    </div>

    <!-- tab: show characters -->
    <div id="tabcontent2" class="tabcontent">
        <h2>Character details</h2>
        <p>Type in (or copy in) some text. Information about all characters in it will be shown.</p>
        <p>For example: 
        <dl>
            <dt><a class="sample" href="#s=cr%65%CC%80me%20br%C3%BBl%C3%A9e">Cre&#x0300;me brûlée</a></dt>
            <dd>A phrase with accented letters</dd>
            <dt><a class="sample" href="#s=1%C3%97%20%F0%9F%8D%95%20%C3%A0%20%E2%82%AC1,%E2%80%92">1× 🍕 à €1,‒</a></dt>
            <dd>More exotic "letters" are possible</dd>
            <dt><a class="sample" href="#s=%D0%A0hishy@%CE%9Cicr%CE%BFs%CE%BFft.com">Рhishy@Μicrοsοft.com</a></dt>
            <dd>You can even detect some phishy addresses (look closely at the letters)</dd>
        </dl>
        </p>
        <p>
            Your text to split in characters:<br />
            <input id="sampleString" type="text" placeholder="Type in (or copy in) the text to inspect" autofocus required
                   onkeyup="processDecoder(this, 'result2', 'link2')" style="width:100%" />
            <!--
      onkeypress reageert niet op "wissen" en geeft oude waarde
      onkeyup reageert ook op cursor keys maar geeft juiste waarde
    -->
        </p>
        <p><a href="#s=" id="link2">Direct link</a></p>
        <div id="result2" class="result">&hellip;</div>
    </div>

    <!-- tab: search by name -->
    <div id="tabcontent3" class="tabcontent">
        <h2>Search by name</h2>
        <p>Type in a partial name of a character or type in its code to find out about it. 
        When you type in a numerical code (decimal or hexadecimal), some characters around it will also be shown.</p>
        <p>When there are too many matches, the list is truncated. Use a more specific search (you can use multiple words in any order) to get a more specific result.</p>
        <p>Examples: <a class="sample" href="#q=phone">phone</a> or 
                     <a class="sample" href="#q=star">star</a></p>
        <p>
            The name or code to search for:<br/>
            <input id="searchString" type="text" placeholder="Type in words of the name to find" autofocus required
                   oninput="processSearch(this, 'result3', 'link3')" style="width:100%" />
        </p>
        <p><a href="#q=" id="link3">Direct link</a></p>
        <div id="result3" class="result">&hellip;</div>
    </div>

    <!-- tab: select block -->
    <div id="tabcontent4" class="tabcontent">
        <h2>Search by block</h2>
        <p>Characters are grouped in blocks. Select a block to see its characters.</p>
        <p>Some characters may be replaced by an empty rectangle: this means that the current font cannot display it.</p>
        <p>Examples: <a class="sample" href="#b=259">Emoticons</a>, 
                    <a class="sample" href="#b=255">Playing cards</a> or 
                    <a class="sample" href="#b=42">Runic</a>.</p>
        <p>
            <select id="blockSelect" onchange="processBlockSearch(this, 'result4', 'link4')"></select>
        </p>
        <p><a href="#b=0" id="link4">Direct link</a></p>
        <div id="result4" class="result">&hellip;</div>
    </div>


    <script id="result-template" type="text/x-handlebars-template">
        {{#each characters}}
        <div class="character">
            <p onclick="cp({{this.codepoint}}, '{{this.name}}')" {{#if this.isLatin}}class="latin"{{/if}}>&#x{{this.hex}};</p>
            <p><b>{{this.name}}</b></p>
            <p><a href="#b={{this.blockId}}">{{this.block}}</a></p>
            <p><i>{{this.category}}</i></p>
            <p><a href="#q={{this.hex}}">{{this.hex}}</a> - <a href="#q={{this.codepoint}}">{{this.codepoint}}</a></p>
        </div>
        {{/each}}
    </script>

    <script id="blockselect-template" type="text/x-handlebars-template">
        {{#each blocks}}
        <option value="{{this.index}}">{{this.name}}</option>
        {{/each}}
    </script>

    <script type="text/javascript">
        (async function () {
            // also pre-fetches the charlist
            await setBlockSelect();
            await processBlockSearch('blockSelect', 'result4');

            window.addEventListener("hashchange", handleHash);
            handleHash();
            await setCharCount();

            console.dir(document.styleSheets[0].cssRules);
        })();
    </script>
</body>
</html>